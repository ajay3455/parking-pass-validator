<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gloucester Barcode Scanner</title>
    <!-- Html5-Qrcode Library for Barcode Scanning -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* Import Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

        /* Reset Margins and Padding */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Body Styling */
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #e0f7e9, #b2f2bb);
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        /* Gloucester Logo */
        .logo {
            width: 150px;
            margin-bottom: 20px;
        }

        /* Scanner Container */
        .scanner-container {
            width: 100%;
            max-width: 400px;
            position: relative;
            margin-bottom: 20px;
        }

        /* Flashlight Button */
        .flashlight-container {
            margin-bottom: 20px;
            width: 100%;
            max-width: 400px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .flashlight-button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #2d6a4f;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .flashlight-button:hover {
            background-color: #1b4332;
        }

        /* Controls Section */
        .controls {
            width: 100%;
            max-width: 400px;
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .controls button, .controls label {
            flex: 1;
            margin: 0 5px;
        }

        .controls button {
            padding: 10px;
            font-size: 16px;
            background-color: #2d6a4f;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .controls button:hover {
            background-color: #1b4332;
        }

        .controls label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            font-size: 16px;
            background-color: #40916c;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .controls label:hover {
            background-color: #2d6a4f;
        }

        /* Hidden File Input */
        #uploadInput {
            display: none;
        }

        /* Phone Number Display */
        .phone-display {
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .phone-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            word-wrap: break-word;
        }

        /* Call Button */
        .call-button {
            display: none; /* Hidden by default */
            padding: 12px 20px;
            font-size: 18px;
            background-color: #2d6a4f;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.3s;
        }

        .call-button:hover {
            background-color: #1b4332;
        }

        /* Status Message */
        .status {
            margin-top: 15px;
            font-size: 16px;
            color: #d00000;
        }

        /* Responsive Design */
        @media (max-width: 500px) {
            .logo {
                width: 120px;
            }

            .phone-number {
                font-size: 20px;
            }

            .call-button {
                font-size: 16px;
                padding: 10px 16px;
            }

            .controls button, .controls label {
                font-size: 14px;
                padding: 8px;
            }

            .flashlight-button {
                font-size: 14px;
                padding: 8px 16px;
            }
        }
    </style>
</head>
<body>

    <!-- Gloucester Logo -->
    <img src="https://i.imgur.com/LmweghF.png" alt="Gloucester Logo" class="logo">

    <!-- Scanner Section -->
    <div class="scanner-container">
        <div id="reader" style="width: 100%;"></div>
    </div>

    <!-- Flashlight Toggle -->
    <div class="flashlight-container">
        <button id="toggleFlashlight" class="flashlight-button">
            ðŸ”¦ Turn On Flashlight
        </button>
    </div>

    <!-- Controls Section -->
    <div class="controls">
        <button id="startScanner">Start Scanning</button>
        <label for="uploadInput">Upload Image</label>
        <input type="file" id="uploadInput" accept="image/*">
    </div>

    <!-- Phone Number Display Section -->
    <div class="phone-display">
        <div class="phone-number" id="phoneNumber">Scan a barcode to get the phone number.</div>
        <a href="#" id="callButton" class="call-button">Call Now</a>
        <div class="status" id="statusMessage"></div>
    </div>

    <script>
        // Initialize Html5-Qrcode
        const html5QrCode = new Html5Qrcode("reader");

        // Function to start scanning
        function startScanning() {
            const config = { fps: 10, qrbox: 250 };
            html5QrCode.start(
                { facingMode: "environment" },
                config,
                onScanSuccess,
                onScanFailure
            ).catch(err => {
                console.error("Unable to start scanning.", err);
                document.getElementById('statusMessage').innerText = "Unable to access camera.";
            });
            document.getElementById('statusMessage').innerText = "Scanning... Please align the barcode within the frame.";
        }

        // Function to handle successful scan
        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Code matched = ${decodedText}`, decodedResult);
            html5QrCode.stop().then(ignore => {
                processScannedCode(decodedText);
            }).catch(err => {
                console.error("Unable to stop scanning.", err);
            });
        }

        // Function to handle scan failure (optional)
        function onScanFailure(error) {
            // Handle scan failure if needed
            // console.warn(`Scan failed: ${error}`);
        }

        // Function to validate phone number
        function validatePhoneNumber(code) {
            // Example validation: 6 to 15 digits
            const phoneRegex = /^\d{6,15}$/;
            if (phoneRegex.test(code)) {
                return code;
            }
            return null;
        }

        // Function to process scanned code
        function processScannedCode(code) {
            const phoneNumber = validatePhoneNumber(code);
            if (phoneNumber) {
                displayPhoneNumber(phoneNumber);
            } else {
                displayPhoneNumber("Invalid or No Phone Number Found.", false);
            }
        }

        // Function to display phone number and show call button
        function displayPhoneNumber(number, isValid = true) {
            const phoneNumberElement = document.getElementById('phoneNumber');
            const callButton = document.getElementById('callButton');
            const statusMessage = document.getElementById('statusMessage');

            if (isValid) {
                phoneNumberElement.innerText = `Phone Number: ${formatPhoneNumber(number)}`;
                callButton.href = `tel:${number}`;
                callButton.style.display = 'inline-block';
                statusMessage.innerText = "";
            } else {
                phoneNumberElement.innerText = number;
                callButton.style.display = 'none';
                statusMessage.innerText = "Please scan a valid phone number barcode.";
            }

            // Reset Scanner after a delay to allow rescanning
            setTimeout(() => {
                phoneNumberElement.innerText = "Scan a barcode to get the phone number.";
                callButton.style.display = 'none';
                statusMessage.innerText = "";
                startScanning();
            }, 5000); // 5 seconds
        }

        // Function to format phone number for display
        function formatPhoneNumber(number) {
            // Example formatting: (123) 456-7890
            if (number.length === 10) {
                return `(${number.substring(0,3)}) ${number.substring(3,6)}-${number.substring(6)}`;
            } else if (number.length === 6) {
                return number; // For '000000' or similar
            }
            return number;
        }

        // Event Listener for Start Scanning Button
        document.getElementById('startScanner').addEventListener('click', function() {
            document.getElementById('statusMessage').innerText = "";
            startScanning();
        });

        // Event Listener for Image Upload
        document.getElementById('uploadInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    // Proceed with processing the image
                    const html5QrCode = new Html5Qrcode("reader");
                    html5QrCode.scanFileV2(file, true)
                        .then(decodedText => {
                            processScannedCode(decodedText);
                        })
                        .catch(err => {
                            console.error(err);
                            displayPhoneNumber("No barcode detected in the image.", false);
                        });
                }
            }).catch(err => {
                console.error(err);
                displayPhoneNumber("Error accessing cameras.", false);
            });
        });

        // Flashlight Control
        let isFlashOn = false;
        let stream = null;
        let videoTrack = null;

        document.getElementById('toggleFlashlight').addEventListener('click', function() {
            toggleFlashlight();
        });

        async function toggleFlashlight() {
            if (!videoTrack) {
                // Attempt to get the video track
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                videoTrack = stream.getVideoTracks()[0];
            }

            if (videoTrack) {
                const capabilities = videoTrack.getCapabilities();
                if ('torch' in capabilities) {
                    try {
                        await videoTrack.applyConstraints({
                            advanced: [{ torch: !isFlashOn }]
                        });
                        isFlashOn = !isFlashOn;
                        updateFlashlightButton();
                    } catch (err) {
                        console.error("Could not toggle flashlight:", err);
                        alert("Unable to toggle flashlight on this device/browser.");
                    }
                } else {
                    alert("Flashlight not supported on this device/browser.");
                }
            } else {
                alert("No video track available to control flashlight.");
            }
        }

        function updateFlashlightButton() {
            const button = document.getElementById('toggleFlashlight');
            if (isFlashOn) {
                button.innerHTML = 'ðŸ”¦ Turn Off Flashlight';
            } else {
                button.innerHTML = 'ðŸ”¦ Turn On Flashlight';
            }
        }

        // Initialize Scanner on Page Load
        window.addEventListener('load', function() {
            startScanning();
        });
    </script>
</body>
</html>
