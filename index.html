<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gloucester Barcode Scanner</title>
    <!-- QuaggaJS Library for Barcode Scanning -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        /* Import Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

        /* Reset Margins and Padding */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Body Styling */
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #e0f7e9, #b2f2bb);
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        /* Gloucester Logo */
        .logo {
            width: 150px;
            margin-bottom: 20px;
        }

        /* Scanner Container */
        .scanner-container {
            width: 100%;
            max-width: 400px;
            position: relative;
            margin-bottom: 20px;
        }

        /* Video Element */
        #video {
            width: 100%;
            height: auto;
            border-radius: 12px;
            border: 2px solid #2d6a4f;
        }

        /* Overlay for Scanning Area */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .overlay .scan-area {
            border: 4px dashed #d00000;
            width: 80%;
            height: 30%;
            position: absolute;
            top: 35%;
            left: 10%;
            border-radius: 8px;
        }

        /* Controls Section */
        .controls {
            width: 100%;
            max-width: 400px;
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .controls button, .controls label {
            flex: 1;
            margin: 0 5px;
        }

        .controls button {
            padding: 10px;
            font-size: 16px;
            background-color: #2d6a4f;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .controls button:hover {
            background-color: #1b4332;
        }

        .controls label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            font-size: 16px;
            background-color: #40916c;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .controls label:hover {
            background-color: #2d6a4f;
        }

        /* Hidden File Input */
        #uploadInput {
            display: none;
        }

        /* Phone Number Display */
        .phone-display {
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .phone-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            word-wrap: break-word;
        }

        /* Call Button */
        .call-button {
            display: none; /* Hidden by default */
            padding: 12px 20px;
            font-size: 18px;
            background-color: #2d6a4f;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.3s;
        }

        .call-button:hover {
            background-color: #1b4332;
        }

        /* Status Message */
        .status {
            margin-top: 15px;
            font-size: 16px;
            color: #d00000;
        }

        /* Responsive Design */
        @media (max-width: 500px) {
            .logo {
                width: 120px;
            }

            .phone-number {
                font-size: 20px;
            }

            .call-button {
                font-size: 16px;
                padding: 10px 16px;
            }

            .controls button, .controls label {
                font-size: 14px;
                padding: 8px;
            }

            .overlay .scan-area {
                width: 90%;
                height: 25%;
                top: 37.5%;
                left: 5%;
            }
        }
    </style>
</head>
<body>

    <!-- Gloucester Logo -->
    <img src="https://i.imgur.com/LmweghF.png" alt="Gloucester Logo" class="logo">

    <!-- Scanner Section -->
    <div class="scanner-container">
        <video id="video" autoplay></video>
        <div class="overlay">
            <div class="scan-area"></div>
        </div>
    </div>

    <!-- Controls Section -->
    <div class="controls">
        <button id="startScanner">Start Scanning</button>
        <label for="uploadInput">Upload Image</label>
        <input type="file" id="uploadInput" accept="image/*">
    </div>

    <!-- Phone Number Display Section -->
    <div class="phone-display">
        <div class="phone-number" id="phoneNumber">Scan a barcode to get the phone number.</div>
        <a href="#" id="callButton" class="call-button">Call Now</a>
        <div class="status" id="statusMessage"></div>
    </div>

    <script>
        // Initialize QuaggaJS for Live Scanning
        function initQuagga() {
            if (Quagga.initialized) return; // Prevent multiple initializations

            Quagga.init({
                inputStream: {
                    type: "LiveStream",
                    constraints: {
                        width: { min: 320 },
                        height: { min: 240 },
                        facingMode: "environment" // Use the back camera
                    },
                    target: document.querySelector('#video') // Video element
                },
                decoder: {
                    readers: ["code_39_reader"] // Specify the barcode format
                },
                locate: true
            }, function(err) {
                if (err) {
                    console.error(err);
                    document.getElementById('statusMessage').innerText = "Error initializing barcode scanner.";
                    return;
                }
                Quagga.initialized = true;
                Quagga.start();
                document.getElementById('statusMessage').innerText = "Scanning... Please align the barcode within the frame.";
            });

            Quagga.onDetected(onDetected);
        }

        // Handle Detected Barcode
        function onDetected(result) {
            Quagga.offDetected(onDetected); // Stop detecting after first scan
            Quagga.stop();

            const code = result.codeResult.code;
            console.log("Scanned Code:", code);

            // Validate that the scanned code is a valid phone number
            const phoneNumber = validatePhoneNumber(code);

            if (phoneNumber) {
                displayPhoneNumber(phoneNumber);
            } else {
                displayPhoneNumber("Invalid or No Phone Number Found.", false);
            }
        }

        // Validate Phone Number (Adjust regex as needed)
        function validatePhoneNumber(code) {
            // Example validation: 6 to 15 digits
            const phoneRegex = /^\d{6,15}$/;
            if (phoneRegex.test(code)) {
                return code;
            }
            return null;
        }

        // Display Phone Number and Show Call Button
        function displayPhoneNumber(number, isValid = true) {
            const phoneNumberElement = document.getElementById('phoneNumber');
            const callButton = document.getElementById('callButton');
            const statusMessage = document.getElementById('statusMessage');

            if (isValid) {
                phoneNumberElement.innerText = `Phone Number: ${formatPhoneNumber(number)}`;
                callButton.href = `tel:${number}`;
                callButton.style.display = 'inline-block';
                statusMessage.innerText = "";
            } else {
                phoneNumberElement.innerText = number;
                callButton.style.display = 'none';
                statusMessage.innerText = "Please scan a valid phone number barcode.";
            }

            // Reset Scanner after a delay to allow rescanning
            setTimeout(() => {
                document.getElementById('phoneNumber').innerText = "Scan a barcode to get the phone number.";
                callButton.style.display = 'none';
                statusMessage.innerText = "";
                initQuagga();
            }, 5000); // 5 seconds
        }

        // Format Phone Number for Display (Optional)
        function formatPhoneNumber(number) {
            // Example formatting: (123) 456-7890 or leave as is for shorter numbers
            if (number.length === 10) {
                return `(${number.substring(0,3)}) ${number.substring(3,6)}-${number.substring(6)}`;
            } else if (number.length > 10) {
                return number; // Adjust based on international formats if needed
            }
            return number;
        }

        // Start Scanner Button Event
        document.getElementById('startScanner').addEventListener('click', function() {
            document.getElementById('statusMessage').innerText = "";
            initQuagga();
        });

        // Handle Image Upload for Scanning
        document.getElementById('uploadInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function() {
                const img = new Image();
                img.src = reader.result;
                img.onload = function() {
                    Quagga.decodeSingle({
                        src: img.src,
                        numOfWorkers: 0, // Needs to be 0 when used within decodeSingle
                        inputStream: {
                            size: 800  // restrict input-size to be scaled to 800px
                        },
                        decoder: {
                            readers: ["code_39_reader"] // Specify the barcode format
                        },
                    }, function(result) {
                        if (result && result.codeResult) {
                            const code = result.codeResult.code;
                            console.log("Decoded Code from Image:", code);
                            const phoneNumber = validatePhoneNumber(code);
                            if (phoneNumber) {
                                displayPhoneNumber(phoneNumber);
                            } else {
                                displayPhoneNumber("Invalid or No Phone Number Found.", false);
                            }
                        } else {
                            displayPhoneNumber("No barcode detected in the image.", false);
                        }
                    });
                }
            }
            reader.readAsDataURL(file);
        });

        // Initialize Scanner on Page Load
        window.addEventListener('load', function() {
            initQuagga();
        });
    </script>
</body>
</html>
