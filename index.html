<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gloucester Barcode Scanner</title>
    <!-- Html5-Qrcode Library for Barcode Scanning -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Import Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

        /* Reset Margins and Padding */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Body Styling */
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #e0f7e9, #b2f2bb);
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        /* Gloucester Logo */
        .logo {
            width: 150px;
            margin-bottom: 20px;
        }

        /* Scanner Container */
        .scanner-container {
            width: 100%;
            max-width: 400px;
            position: relative;
            margin-bottom: 20px;
        }

        /* Scan Area Overlay - Rectangular */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .overlay .scan-area {
            border: 4px dashed #d00000;
            width: 90%;
            height: 30%;
            position: absolute;
            top: 35%;
            left: 5%;
            border-radius: 8px;
        }

        /* Flashlight Button */
        .flashlight-container {
            margin-bottom: 20px;
            width: 100%;
            max-width: 400px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .flashlight-button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #ff8c00; /* Dark Orange */
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .flashlight-button:hover {
            background-color: #e07b00;
        }

        /* Controls Section */
        .controls {
            width: 100%;
            max-width: 400px;
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .controls button, .controls label {
            flex: 1;
            margin: 0 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        /* Start Scanning Button */
        .start-button {
            padding: 10px;
            font-size: 16px;
            background-color: #2d6a4f; /* Dark Green */
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .start-button:hover {
            background-color: #1b4332;
        }

        /* Upload Image Label */
        .upload-label {
            padding: 10px;
            font-size: 16px;
            background-color: #40916c; /* Teal */
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            justify-content: center;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .upload-label:hover {
            background-color: #2d6a4f;
        }

        /* Hidden File Input */
        #uploadInput {
            display: none;
        }

        /* Phone Number Display */
        .phone-display {
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .phone-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            word-wrap: break-word;
        }

        /* Call Button */
        .call-button {
            display: none; /* Hidden by default */
            padding: 12px 20px;
            font-size: 18px;
            background-color: #007bff; /* Blue */
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .call-button:hover {
            background-color: #0056b3;
        }

        /* Status Message */
        .status {
            margin-top: 15px;
            font-size: 16px;
            color: #d00000;
        }

        /* Scanned Numbers List */
        .scanned-list {
            width: 100%;
            max-width: 400px;
            margin-top: 20px;
        }

        .scanned-item {
            background-color: #f0f0f0;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .scanned-item .number {
            font-size: 18px;
        }

        .scanned-item .call-button {
            background-color: #28a745; /* Green */
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 14px;
        }

        .scanned-item .call-button:hover {
            background-color: #1e7e34;
        }

        /* Responsive Design */
        @media (max-width: 500px) {
            .logo {
                width: 120px;
            }

            .phone-number {
                font-size: 20px;
            }

            .call-button, .scanned-item .call-button {
                font-size: 16px;
                padding: 10px 16px;
            }

            .controls button, .controls label, .flashlight-button {
                font-size: 14px;
                padding: 8px;
            }

            .overlay .scan-area {
                width: 90%;
                height: 30%;
                top: 35%;
                left: 5%;
            }
        }
    </style>
</head>
<body>

    <!-- Gloucester Logo -->
    <img src="https://i.imgur.com/LmweghF.png" alt="Gloucester Logo" class="logo">

    <!-- Scanner Section -->
    <div class="scanner-container">
        <div id="reader" style="width: 100%;"></div>
    </div>

    <!-- Flashlight Toggle -->
    <div class="flashlight-container">
        <button id="toggleFlashlight" class="flashlight-button">
            <i class="fas fa-lightbulb"></i> Turn On Flashlight
        </button>
    </div>

    <!-- Controls Section -->
    <div class="controls">
        <button id="startScanner" class="start-button">
            <i class="fas fa-play"></i> Start Scanning
        </button>
        <label for="uploadInput" class="upload-label">
            <i class="fas fa-upload"></i> Upload Image
        </label>
        <input type="file" id="uploadInput" accept="image/*">
    </div>

    <!-- Phone Number Display Section -->
    <div class="phone-display">
        <div class="phone-number" id="phoneNumber">Scan a barcode to get the phone number.</div>
        <a href="#" id="callButton" class="call-button">
            <i class="fas fa-phone"></i> Call Now
        </a>
        <div class="status" id="statusMessage"></div>
    </div>

    <!-- Scanned Numbers List -->
    <div class="scanned-list" id="scannedList">
        <!-- Dynamically added scanned numbers will appear here -->
    </div>

    <script>
        // Initialize Html5-Qrcode
        const html5QrCode = new Html5Qrcode("reader");
        let isScanning = false;
        let isFlashOn = false;
        let stream = null;
        let videoTrack = null;

        // Function to start scanning
        function startScanning() {
            if (isScanning) return;

            const config = { fps: 15, qrbox: { width: 300, height: 100 }, aspectRatio: 3 }; // Rectangular scan area

            html5QrCode.start(
                { facingMode: "environment" },
                config,
                onScanSuccess,
                onScanFailure
            ).then(() => {
                isScanning = true;
                document.getElementById('statusMessage').innerText = "Scanning... Please align the barcode within the frame.";
                document.getElementById('startScanner').disabled = true;
            }).catch(err => {
                console.error("Unable to start scanning.", err);
                document.getElementById('statusMessage').innerText = "Unable to access camera.";
            });
        }

        // Function to handle successful scan
        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Code matched = ${decodedText}`, decodedResult);
            html5QrCode.pause(); // Pause scanning to process the result
            processScannedCode(decodedText);
        }

        // Function to handle scan failure (optional)
        function onScanFailure(error) {
            // Optionally handle scan failures
            // console.warn(`Scan failed: ${error}`);
        }

        // Function to validate phone number
        function validatePhoneNumber(code) {
            // Example validation: 6 to 15 digits
            const phoneRegex = /^\d{6,15}$/;
            if (phoneRegex.test(code)) {
                return code;
            }
            return null;
        }

        // Function to process scanned code
        function processScannedCode(code) {
            const phoneNumber = validatePhoneNumber(code);
            if (phoneNumber) {
                addScannedNumber(phoneNumber);
                displayPhoneNumber(phoneNumber);
            } else {
                displayPhoneNumber("Invalid or No Phone Number Found.", false);
            }

            // Resume scanning after a short delay
            setTimeout(() => {
                if (isScanning) {
                    html5QrCode.resume();
                }
            }, 3000); // 3 seconds
        }

        // Function to display phone number and show call button
        function displayPhoneNumber(number, isValid = true) {
            const phoneNumberElement = document.getElementById('phoneNumber');
            const callButton = document.getElementById('callButton');
            const statusMessage = document.getElementById('statusMessage');

            if (isValid) {
                phoneNumberElement.innerText = `Phone Number: ${formatPhoneNumber(number)}`;
                callButton.href = `tel:${number}`;
                callButton.style.display = 'inline-flex';
                statusMessage.innerText = "";
            } else {
                phoneNumberElement.innerText = number;
                callButton.style.display = 'none';
                statusMessage.innerText = "Please scan a valid phone number barcode.";
            }
        }

        // Function to add scanned number to the list
        function addScannedNumber(number) {
            const scannedList = document.getElementById('scannedList');
            const item = document.createElement('div');
            item.classList.add('scanned-item');

            const numberDiv = document.createElement('div');
            numberDiv.classList.add('number');
            numberDiv.innerText = formatPhoneNumber(number);

            const callBtn = document.createElement('a');
            callBtn.classList.add('call-button');
            callBtn.href = `tel:${number}`;
            callBtn.innerHTML = `<i class="fas fa-phone"></i> Call`;

            item.appendChild(numberDiv);
            item.appendChild(callBtn);
            scannedList.prepend(item); // Add to the top of the list
        }

        // Function to format phone number for display
        function formatPhoneNumber(number) {
            // Example formatting: (123) 456-7890 or leave as is for shorter numbers
            if (number.length === 10) {
                return `(${number.substring(0,3)}) ${number.substring(3,6)}-${number.substring(6)}`;
            } else if (number.length === 6) {
                return number; // For '000000' or similar
            }
            return number;
        }

        // Event Listener for Start Scanning Button
        document.getElementById('startScanner').addEventListener('click', function() {
            document.getElementById('statusMessage').innerText = "";
            startScanning();
        });

        // Event Listener for Image Upload
        document.getElementById('uploadInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    const html5QrCode = new Html5Qrcode("reader");
                    html5QrCode.scanFileV2(file, true)
                        .then(decodedText => {
                            processScannedCode(decodedText);
                        })
                        .catch(err => {
                            console.error(err);
                            displayPhoneNumber("No barcode detected in the image.", false);
                        });
                }
            }).catch(err => {
                console.error(err);
                displayPhoneNumber("Error accessing cameras.", false);
            });
        });

        // Flashlight Control
        document.getElementById('toggleFlashlight').addEventListener('click', function() {
            toggleFlashlight();
        });

        async function toggleFlashlight() {
            try {
                if (!stream) {
                    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    videoTrack = stream.getVideoTracks()[0];
                }

                if (videoTrack) {
                    const capabilities = videoTrack.getCapabilities();
                    if ('torch' in capabilities) {
                        await videoTrack.applyConstraints({
                            advanced: [{ torch: !isFlashOn }]
                        });
                        isFlashOn = !isFlashOn;
                        updateFlashlightButton();
                    } else {
                        alert("Flashlight not supported on this device/browser.");
                    }
                } else {
                    alert("No video track available to control flashlight.");
                }
            } catch (err) {
                console.error("Could not toggle flashlight:", err);
                alert("Unable to toggle flashlight on this device/browser.");
            }
        }

        function updateFlashlightButton() {
            const button = document.getElementById('toggleFlashlight');
            if (isFlashOn) {
                button.innerHTML = '<i class="fas fa-lightbulb"></i> Turn Off Flashlight';
            } else {
                button.innerHTML = '<i class="fas fa-lightbulb"></i> Turn On Flashlight';
            }
        }

        // Initialize Scanner on Page Load
        window.addEventListener('load', function() {
            startScanning();
        });
    </script>
</body>
</html>
